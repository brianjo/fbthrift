<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-cpp/cpp2">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Cpp2 ThriftServer | Facebook Thrift</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.internalfb.com/fbthrift/docs/cpp/cpp2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cpp2 ThriftServer | Facebook Thrift"><meta data-rh="true" name="description" content="This is a re-implementation of both the generated cpp code, and a"><meta data-rh="true" property="og:description" content="This is a re-implementation of both the generated cpp code, and a"><link data-rh="true" rel="icon" href="/fbthrift/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.internalfb.com/fbthrift/docs/cpp/cpp2"><link data-rh="true" rel="alternate" href="https://www.internalfb.com/fbthrift/docs/cpp/cpp2" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.internalfb.com/fbthrift/docs/cpp/cpp2" hreflang="x-default"><link rel="stylesheet" href="/fbthrift/assets/css/styles.afc07cdd.css">
<link rel="preload" href="/fbthrift/assets/js/runtime~main.18b8a5ef.js" as="script">
<link rel="preload" href="/fbthrift/assets/js/main.8d55481e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/fbthrift/"><div class="navbar__logo"><img src="/fbthrift/img/logo.svg" alt="Facebook Thrift Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/fbthrift/img/logo.svg" alt="Facebook Thrift Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Facebook Thrift</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/fbthrift/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/fbthrift" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/fbthrift/docs/spec/">Specification</a><button aria-label="Toggle the collapsible sidebar category &#x27;Specification&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/fbthrift/docs/guide/">User Guide</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Guide&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/fbthrift/docs/experimental/">Experimental Features</a><button aria-label="Toggle the collapsible sidebar category &#x27;Experimental Features&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/fbthrift/docs/beta/">Beta Features</a><button aria-label="Toggle the collapsible sidebar category &#x27;Beta Features&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/fbthrift/docs/cpp/">C++</a><button aria-label="Toggle the collapsible sidebar category &#x27;C++&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/fbthrift/docs/cpp/channel">Channels in C++</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/fbthrift/docs/cpp/cpp2">Cpp2 ThriftServer</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/fbthrift/docs/internals/">Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/debugging">Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/references/">References</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fbthrift/docs/contribution-guide">Contribution Guide</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Cpp2 ThriftServer</h1><p>This is a re-implementation of both the generated cpp code, and a
fully asynchronous version of the c++ server code. In many ways it is
similar to the older first-generation implementation:</p><ul><li><p>Can run code inline, or in a ThreadManager queue.</p></li><li><p>Has a single acceptor thread, and hands off the accepts to IO
threads.</p></li><li><p>Has many options to handle server overload.</p></li><li><p>Uses libevent.</p></li><li><p>Maintains wire-format and IDL backwards compatibility.</p></li></ul><p><em>And many differences:</em></p><ul><li><p>Updated for C++11.</p></li><li><p>Can optionally provide an asynchronous callback, or future
interface, as well as the previous synchronous server interface.</p></li><li><p>Responses can be sent to the client out of order, and processed in
parallel.</p></li><li><p>Supports dynamic compression and tracing via the header.</p></li><li><p>Uses eventfd instead of pipes for notification.</p></li><li><p>Uses buffer chains
(<a href="https://github.com/facebook/folly/blob/master/folly/io/IOBuf.h" target="_blank" rel="noopener noreferrer">folly/io/IOBuf.h</a>)
to prevent large allocations of memory.</p></li><li><p>Allows true zero-copy from client to server and back using IOBufs
(vs. previous generated code that used std::string for binary type).</p></li><li><p>It&#x27;s about 4x as fast as NonblockingServer in our load tests
(<code>perf/cpp</code>) for small requests. Latency is also much improved
depending on how parallel processing and out of order responses are
used.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h3><p>This document assumes you are familiar with basic Thrift usage. We
recommend the following to become familiar:
<a href="http://thrift.apache.org/" target="_blank" rel="noopener noreferrer">Apache Thrift</a>,
<a href="http://diwakergupta.github.io/thrift-missing-guide/" target="_blank" rel="noopener noreferrer">Thrift: The Missing Guide</a>,
and <a href="http://jnb.ociweb.com/jnb/jnbJun2009.html" target="_blank" rel="noopener noreferrer">SETT on Apache Thrift</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="options">Options<a class="hash-link" href="#options" title="Direct link to heading">​</a></h3><p>Useful (but not complete set of) options that can be set on the ThriftServer:</p><ul><li><p><code>setPort(int)</code> - set port to listen on.</p></li><li><p><code>setIdleTimeout(std::chrono::milliseconds)</code> - milliseconds before we close idle connections.</p></li><li><p><code>setTaskExpireTime(std::chrono::milliseconds)</code> - milliseconds before
we timeout any individual request. This can also be set on a
per-function bases by overriding the appropriate generated code
method.</p></li><li><p><code>setNumIOWorkerThreads(int)</code> - Number of IO async worker threads. Defaults to number of cores.</p></li><li><p><code>setNumCPUWorkerThreads(int)</code> - Number of synchronous pool threads. Defaults
to number of IO threads. If you do a lot of blocking synchronous
work, you may want to increase this. This controls the number of normal
priority threads; the Thrift thread manager can create additional threads for
other priorities.</p></li><li><p><code>setInterface(std::shared_ptr&lt;ServerInterface&gt;)</code> - Your Thrift handler
interface that subclasses the generated code.</p></li><li><p><code>setMaxRequests(uint32_t)</code> - The maximum number of outstanding
requests.</p></li><li><p><code>setSSLContext(context)</code> - Allow SSL connections.</p></li></ul><p><em>There are other options for specific use cases, such as</em></p><ul><li><code>setProcessorFactory(factory)</code> - Not necessary if setInterface is
called. Used for custom processors, usually proxies.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-example">Code example<a class="hash-link" href="#code-example" title="Direct link to heading">​</a></h3><p>A service like the following</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">service TestService {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  string sendResponse(1:i64 size)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Will generate an interface similar to</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">class TestServiceSvIf : public TestServiceSvAsyncIf, public apache::thrift2::ServerInterface {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  virtual void sendResponse(std::string&amp; _return, int64_t size);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  virtual void async_sendResponse(std::unique_ptr&lt;apache::thrift2::HandlerCallback&lt;std::unique_ptr&lt;std::string&gt;&gt;&gt; callback, int64_t size) = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  virtual folly::Future&lt;std::unique_ptr&lt;std::string&gt;&gt; future_sendResponse(int64_t size);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So you have three choices of handler type to implement:</p><ol><li><p><code>sendResponse(...)</code> is the synchronous method. It will be read and
deserialized in an IO thread, and then passed to a pool thread to be
executed. When it returns, <code>_return</code> must contain the result, which
will be passed back to the original IO thread to serialize the
result and send it on the wire. You can block in this handler as
long as you wish, although you may need to tune the server more.</p></li><li><p><code>async_sendResponse(callback...)</code> is a callback-style handler. The
base callback types are defined in <a href="https://github.com/facebook/fbthrift/blob/master/thrift/lib/cpp2/async/AsyncProcessor.h" target="_blank" rel="noopener noreferrer">AsyncProcessor.h</a>.
Your handler method is called in the context of the receiving IO
thread: This is meant so that you can make additional IO bound
calls. If you need to do CPU bound work, it would be better to
transfer it to the ThreadManager thread pool instead of blocking
IO. Pseudocode Example:</p></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    virtual void async_sendResponse(std::unique_ptr&lt;apache::thrift2::HandlerCallback&lt;std::unique_ptr&lt;std::string&gt;&gt;&gt; callback, int64_t size) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      auto client = getClient();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      client-&gt;forwardSendRespose([=](Result&amp; result){</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        callback-&gt;result(result);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }, size);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>  (In production code, care would have to be taken with the lifetime
of the callback object, and which thread it is called on. See
<a href="https://github.com/facebook/fbthrift/blob/master/thrift/lib/cpp2/async/AsyncProcessor.h" target="_blank" rel="noopener noreferrer">AsyncProcessor.h</a> for more info on Callback
objects).</p><ol start="3"><li><code>future_sendResponse(...)</code> future interface
<!-- -->[<em>currently fb only</em>]<!-- -->. Your handler must return a future object.
When the future completes, the result will be sent.</li></ol><p>You only need to override one of these methods in your handler. They
will be called in turn until an overridden method is found. If you do
not override any method, you will get a runtime error when the method
is called.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-generated-code-features">New generated code features<a class="hash-link" href="#new-generated-code-features" title="Direct link to heading">​</a></h3><p>The compiler was rewritten from scratch. We have found that adding
new features was difficult, especially where we needed to manage
changes to .h, .cpp, and .tcc files simultaneously. Instead, the
python framework automatically knows which file changes need to go in.</p><ul><li><p>Compatibility mode: Typedefs generated structs to be the original
cpp implementation. This is useful in that you can mix cpp and cpp2
code freely, assuming they are in different namespaces. This
precludes using some of the newer features below, however.</p></li><li><p>Full Zero Copy binary type: To change the default binary type to
IOBuf, do something like</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  typedef binary (cpp.type = &quot;std::unique_ptr&lt;folly::IOBuf&gt;&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IOBufPtr</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can also change the map and other complex types to whatever you
want this way.</p></li><li><p>enum class: Enums are now generated with C++11&#x27;s enum class
feature.</p></li><li><p>Arguments on heap: By default, complex arguments are on the heap, so
they can be moved between threads without a copy. To disable this,
use option <code>stack_arguments</code>.</p></li><li><p>Optional / Required by default are the same as before. Using option
<code>terse_writes</code> will make it behave more like the dynamic
languages: If the field is the same as the default value (or
nothing if no default value is set), then it won&#x27;t ever be sent on
the wire.</p></li><li><p>Support for floats was added.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="serialization-using-iobufs">Serialization using IOBufs<a class="hash-link" href="#serialization-using-iobufs" title="Direct link to heading">​</a></h3><p>An IOBuf is a network chained memory buffer, similar to FreeBSD&#x27;s
mbuf, or the Linux kernel&#x27;s sk_buff. They can have the memory
internally if small enough, or externally malloced and shared. This is
opaque to the user and done mostly for performance reasons, similar
to fbstring. The IOBuf header itself can point to a subregion of the
allocated memory, like a view.</p><p>The main use in Thrift is to allow readahead for incoming data, and
support chaining + writev for outgoing data. Both of these will reduce
the usage of expensive syscalls. A secondary advantage is that we only
need malloc small blocks of data at a time, which is much easier on
the allocator than trying to allocate large megabytes of data.</p><p><img loading="lazy" alt="IO Readahead" src="/fbthrift/assets/images/iobuf-readahead-8ef4babe7784bcd35010a78fda17871d.png" width="594" height="664" class="img_ev3q"></p><p>When the Thrift channel reads the last part of a frame, it clones the
IOBuf. There are now two &#x27;views&#x27; on the same shared memory segment:
One part has the first part of the buffer (which is the last part of
the frame), the other is the last part of the buffer, which is the
first part of the readahead data.</p><p><img loading="lazy" alt="IO Write Buffering" src="/fbthrift/assets/images/iobuf-write-buffering-301dea94fc9f60634d52296b7c74de7c.png" width="892" height="325" class="img_ev3q"></p><p>Write buffering is similar but in reverse: When sending a response, we
serialize it, then add it to an IOBuf queue. Once per TEventBase loop,
we call writeV with the whole of the queue.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a class="hash-link" href="#performance" title="Direct link to heading">​</a></h3><ul><li><p>The standard memory allocator for glibc generally has high overhead,
especially in a threaded environment. There are two factors
involved: locking and fragmentation. The glibc allocator uses a
global mutex to allow threads to share a common heap. Since the heap
is used extensively in Thrift serialization/deserialization and
elsewhere (e.g. <code>std::shared_ptr</code>, <code>std::bind</code>) there is a great deal
of contention for that lock. Alternative allocators such as
<a href="https://www.facebook.com/jemalloc" target="_blank" rel="noopener noreferrer">jemalloc</a> maintain per-thread
heap resources such that locking is much less of an issue. They also
tend to fragment memory less, though because allocation algorithms
differ they can use more or less process memory than glibc. Although
tcmalloc has been used with excellent results, jemalloc has in some
cases demonstrated even better performance and has the advantage of
being actively supported and enhanced by Facebook engineer Jason
Evans.</p></li><li><p>Using the load generator, we get some good numbers for QPS. This one
is Noop&#x27;s, one thread per core, and sending up to 100 outstanding
requests to fill up the buffer and show off the readahead / write
queueing. (Note that performance is similar to previous Thrift
servers if there is only one outstanding request at a time). In
practice, it seems raw qps for in-memory type servers (like
key-value store or similar) is at least 20% better than previous
servers.</p><p><img loading="lazy" alt="Thrift Noop Performance" src="/fbthrift/assets/images/thrift2-server-noop-perf-4145a67e13b96a4e2e5981b475ebd04d.png" width="361" height="435" class="img_ev3q"></p><p>To show off the out of order responses, we send a mix of burn (which
happens in a task queue), and noop. We would expect noop to have a
much lower std dev if out of order is working properly.</p><p><img loading="lazy" alt="Thrift Out Of Order Performance" src="/fbthrift/assets/images/thrift2-server-out-of-order-perf-78989faf8d40011666f416be9360621f.png" width="363" height="434" class="img_ev3q"></p><p>(times in ms, QPS happen to be in k, but these numbers highly
dependent on burn time) In practice, out of order does indeed
reduce latency by almost 50% if your service has interleaved long
and short requests, but we only saw the improvement at p75 and
above.</p></li><li><p>The previous Thrift ThreadManager used mutexs and condition
variables to queue tasks and wake up threads. In practice, this
limited the throughput to around 300k qps. We have overhauled
ThreadManager to use a lockless MPMC queue, as well as adding LIFO
worker thread semantics. This improved the throughput to just under
1M qps. Unfortunately, it is still sensitive to tuning for the
number of worker and IO threads, due to context switching overhead.</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/fbthrift/blob/main/thrift/website/../doc/cpp/cpp2.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/fbthrift/docs/cpp/channel"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Channels in C++</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/fbthrift/docs/internals/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Internals</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#options" class="table-of-contents__link toc-highlight">Options</a></li><li><a href="#code-example" class="table-of-contents__link toc-highlight">Code example</a></li><li><a href="#new-generated-code-features" class="table-of-contents__link toc-highlight">New generated code features</a></li><li><a href="#serialization-using-iobufs" class="table-of-contents__link toc-highlight">Serialization using IOBufs</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/fbthrift/docs/">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/thrift" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://engineering.fb.com/2014/02/20/open-source/under-the-hood-building-and-open-sourcing-fbthrift/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/fbthrift" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/fbthrift/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/fbthrift/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright © 2022 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/fbthrift/assets/js/runtime~main.18b8a5ef.js"></script>
<script src="/fbthrift/assets/js/main.8d55481e.js"></script>
</body>
</html>