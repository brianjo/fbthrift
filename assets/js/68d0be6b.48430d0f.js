"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3937],{3905:(e,t,a)=>{a.r(t),a.d(t,{MDXContext:()=>m,MDXProvider:()=>c,mdx:()=>u,useMDXComponents:()=>p,withMDXComponents:()=>l});var r=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},o.apply(this,arguments)}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function d(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var m=r.createContext({}),l=function(e){return function(t){var a=p(t.components);return r.createElement(e,o({},t,{components:a}))}},p=function(e){var t=r.useContext(m),a=t;return e&&(a="function"==typeof e?e(t):d(d({},t),e)),a},c=function(e){var t=p(e.components);return r.createElement(m.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},f=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),l=p(a),c=n,f=l["".concat(i,".").concat(c)]||l[c]||h[c]||o;return a?r.createElement(f,d(d({ref:t},m),{},{components:a})):r.createElement(f,d({ref:t},m))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=f;var d={};for(var s in t)hasOwnProperty.call(t,s)&&(d[s]=t[s]);d.originalType=e,d.mdxType="string"==typeof e?e:n,i[1]=d;for(var m=2;m<o;m++)i[m]=a[m];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}f.displayName="MDXCreateElement"},70547:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>d,toc:()=>m});var r=a(83117),n=(a(67294),a(3905));const o={state:"draft"},i="Rocket Protocol",d={unversionedId:"spec/protocol/interface/rocket",id:"spec/protocol/interface/rocket",title:"Rocket Protocol",description:"This document describes the Rocket transport protocol and how it is used by Thrift to achieve the Interface Types by using RSocket.",source:"@site/../doc/spec/protocol/interface/rocket.md",sourceDirName:"spec/protocol/interface",slug:"/spec/protocol/interface/rocket",permalink:"/docs/spec/protocol/interface/rocket",draft:!1,editUrl:"https://github.com/facebook/fbthrift/blob/main/thrift/website/../doc/spec/protocol/interface/rocket.md",tags:[],version:"current",frontMatter:{state:"draft"},sidebar:"sidebar",previous:{title:"Interface Protocols",permalink:"/docs/spec/protocol/interface/"},next:{title:"User Guide",permalink:"/docs/guide/"}},s={},m=[{value:"Thrift Protocol Negotiation",id:"thrift-protocol-negotiation",level:2},{value:"Rocket/RSocket over TLS",id:"rocketrsocket-over-tls",level:3},{value:"Other transport (e.g. THeader) to Rocket/RSocket upgrade",id:"other-transport-eg-theader-to-rocketrsocket-upgrade",level:3},{value:"Versioning",id:"versioning",level:2},{value:"Connection setup",id:"connection-setup",level:2},{value:"Rocket protocol version 9+",id:"rocket-protocol-version-9",level:3},{value:"Rocket protocol version 8",id:"rocket-protocol-version-8",level:3},{value:"Request-Response",id:"request-response",level:2},{value:"Declared Exception",id:"declared-exception",level:3},{value:"Undeclared Exception",id:"undeclared-exception",level:3},{value:"Any Exception",id:"any-exception",level:3},{value:"Internal Server Error",id:"internal-server-error",level:3},{value:"Oneway Request (request no response)",id:"oneway-request-request-no-response",level:2},{value:"Stream",id:"stream",level:2},{value:"Stream Initial Response",id:"stream-initial-response",level:3},{value:"Stream Responses",id:"stream-responses",level:3},{value:"Stream Exception",id:"stream-exception",level:3},{value:"Flow Control",id:"flow-control",level:3},{value:"Cancellation",id:"cancellation",level:3},{value:"Sink",id:"sink",level:2},{value:"Sink Initial Response",id:"sink-initial-response",level:3},{value:"Sink Payloads",id:"sink-payloads",level:3},{value:"Sink Exception",id:"sink-exception",level:3},{value:"Final Response",id:"final-response",level:3},{value:"Flow Control",id:"flow-control-1",level:3},{value:"Interactions",id:"interactions",level:2},{value:"Factory Functions",id:"factory-functions",level:3},{value:"Subsequent Requests",id:"subsequent-requests",level:3},{value:"Termination",id:"termination",level:3},{value:"Control messages",id:"control-messages",level:2},{value:"Control messages from the server",id:"control-messages-from-the-server",level:3},{value:"Control messages from the client",id:"control-messages-from-the-client",level:3}],l={toc:m};function p(e){let{components:t,...a}=e;return(0,n.mdx)("wrapper",(0,r.Z)({},l,a,{components:t,mdxType:"MDXLayout"}),(0,n.mdx)("h1",{id:"rocket-protocol"},"Rocket Protocol"),(0,n.mdx)("p",null,"This document describes the Rocket transport protocol and how it is used by Thrift to achieve the ",(0,n.mdx)("a",{parentName:"p",href:"/docs/spec/definition/"},"Interface Types")," by using ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol"},"RSocket"),"."),(0,n.mdx)("h2",{id:"thrift-protocol-negotiation"},"Thrift Protocol Negotiation"),(0,n.mdx)("h3",{id:"rocketrsocket-over-tls"},"Rocket/RSocket over TLS"),(0,n.mdx)("p",null,'If ALPN is supported by both client and server - "rs" MUST be used as a RSocket protocol identifier.'),(0,n.mdx)("h3",{id:"other-transport-eg-theader-to-rocketrsocket-upgrade"},"Other transport (e.g. THeader) to Rocket/RSocket upgrade"),(0,n.mdx)("p",null,"Once a non-Rocket Thrift connection is established - an upgrade to Rocket/RSocket SHOULD be attempted by the client."),(0,n.mdx)("p",null,"To perform an upgrade a client MUST use the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RocketUpgrade.thrift"},"RocketUpgrade")," interface immediately after opening the connection."),(0,n.mdx)("p",null,"If the upgrade was successful - both server and client MUST treat the connection as a newly established RSocket connection."),(0,n.mdx)("h2",{id:"versioning"},"Versioning"),(0,n.mdx)("p",null,"Rocket follows a versioning scheme consisting of a single numeric version. This document describes protocol versions 8 through 10."),(0,n.mdx)("h2",{id:"connection-setup"},"Connection setup"),(0,n.mdx)("h3",{id:"rocket-protocol-version-9"},"Rocket protocol version 9+"),(0,n.mdx)("p",null,"RSocket setup frame MUST use application/x-rocket-metadata+compact as Metadata Encoding MIME Type and application/x-rocket-payload as Data Encoding MIME Type."),(0,n.mdx)("p",null,"RSocket setup payload MUST consist of a compact-serialized ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestSetupMetadata"))," struct. Such compact-serialized ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestSetupMetadata"))," MAY be prefixed by a 32-bit ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"kRocketProtocolKey"))," if Rocket client wants to remain compatible with Rocket server using Rocket protocol version 6-8."),(0,n.mdx)("p",null,"If connection establishment was successful, the server MUST respond with a SetupResponse control message."),(0,n.mdx)("h3",{id:"rocket-protocol-version-8"},"Rocket protocol version 8"),(0,n.mdx)("p",null,"RSocket setup payload MUST consist of a 32-bit ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"kRocketProtocolKey"))," followed by a compact-serialized ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestSetupMetadata"))," struct."),(0,n.mdx)("p",null,"If connection establishment was successful, the server MUST respond with a SetupResponse control message."),(0,n.mdx)("h2",{id:"request-response"},"Request-Response"),(0,n.mdx)("p",null,"With an already established connection, the client must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#request_response-frame-0x04"},"REQUEST_RESPONSE")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized arguments from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#request"},"Interface Protocol"))))),(0,n.mdx)("p",null,"The Thrift server should then perform the method specified in the RequestRpcMetadata method name field. Once the result is ready, the server should send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#payload-frame-0x0a"},"PAYLOAD")," frame containing the result in the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized result from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#response"},"Interface Protocol"))))),(0,n.mdx)("h3",{id:"declared-exception"},"Declared Exception"),(0,n.mdx)("p",null,"If the response is a ",(0,n.mdx)("a",{parentName:"p",href:"/docs/spec/definition/exception#exceptions"},"declared exception"),", the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadMetadata"))," in the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#ResponseRpcMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct ",(0,n.mdx)("strong",{parentName:"p"},"must")," contain a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadExceptionMetadataBase"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadExceptionMetadataBase"))," which contains a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadDeclaredExceptionMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadDeclaredExceptionMetadata"))," struct."),(0,n.mdx)("h3",{id:"undeclared-exception"},"Undeclared Exception"),(0,n.mdx)("p",null,"If the response is an ",(0,n.mdx)("a",{parentName:"p",href:"/docs/spec/definition/exception#exceptions"},"undeclared exception"),", the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadMetadata"))," in the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#ResponseRpcMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct ",(0,n.mdx)("strong",{parentName:"p"},"must")," contain a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadExceptionMetadataBase"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadExceptionMetadataBase"))," which contains a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadAppUnknownExceptionMetdata"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadAppUnknownExceptionMetdata"))," struct."),(0,n.mdx)("h3",{id:"any-exception"},"Any Exception"),(0,n.mdx)("p",null,"If the response is an Any exception, the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadMetadata"))," in the ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#ResponseRpcMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct ",(0,n.mdx)("strong",{parentName:"p"},"must")," contain a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadExceptionMetadataBase"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadExceptionMetadataBase"))," which contains a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#PayloadAnyExceptionMetadata"},(0,n.mdx)("inlineCode",{parentName:"a"},"PayloadAnyExceptionMetadata"))," struct."),(0,n.mdx)("h3",{id:"internal-server-error"},"Internal Server Error"),(0,n.mdx)("p",null,"Internal server errors ",(0,n.mdx)("strong",{parentName:"p"},"must")," be sent as an ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#error-frame-0x0b"},"ERROR")," frame using the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Error code"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Should be one of ",(0,n.mdx)("a",{parentName:"td",href:"https://rsocket.io/about/protocol/#error-codes"},"REJECTED"),", ",(0,n.mdx)("a",{parentName:"td",href:"https://rsocket.io/about/protocol/#error-codes"},"CANCELED"),", or ",(0,n.mdx)("a",{parentName:"td",href:"https://rsocket.io/about/protocol/#error-codes"},"INVALID"))),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Error data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift#ResponseRpcError"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcError"))," struct")))),(0,n.mdx)("p",null,"The ",(0,n.mdx)("inlineCode",{parentName:"p"},"ResponseErrorCode")," in the ",(0,n.mdx)("inlineCode",{parentName:"p"},"ResponseRpcError")," struct is a mapping from the error code in the ",(0,n.mdx)("a",{parentName:"p",href:"/docs/spec/protocol/interface/#internal-server-error"},"Interface protocol"),"."),(0,n.mdx)("h2",{id:"oneway-request-request-no-response"},"Oneway Request (request no response)"),(0,n.mdx)("p",null,"With an already established connection, the client must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#request_fnf-fire-n-forget-frame-0x05"},"REQUEST_FNF")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized arguments from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#request"},"Interface Protocol"))))),(0,n.mdx)("h2",{id:"stream"},"Stream"),(0,n.mdx)("p",null,"With an already established connection, the client must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#request_stream-frame-0x06"},"REQUEST_STREAM")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Initial request N"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Value MUST be > 0. First credit is always consumed by initial response")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized arguments from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#request"},"Interface Protocol"))))),(0,n.mdx)("h3",{id:"stream-initial-response"},"Stream Initial Response"),(0,n.mdx)("p",null,"The initial response for a stream is distinct from ",(0,n.mdx)("a",{parentName:"p",href:"#stream-responses"},"streaming responses")," and it must be sent from the server even if there is no initial response type specified in the IDL. The initial response should be sent using the same format as a regular ",(0,n.mdx)("a",{parentName:"p",href:"#request-response"},"Request-Response response")," with the distinction that the Complete flag must only be set if the payload contains an exception."),(0,n.mdx)("h3",{id:"stream-responses"},"Stream Responses"),(0,n.mdx)("p",null,"Once a stream has been established, the server can send stream payloads to the client as long as it has credits remaining. Sending a stream payload must consume one credit on the server. To send a stream payload to the client, the server must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#payload-frame-0x0a"},"PAYLOAD")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamPayloadMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized result from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#response"},"Interface Protocol")," using the serialization protocol specified in ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")))),(0,n.mdx)("h3",{id:"stream-exception"},"Stream Exception"),(0,n.mdx)("p",null,"Once a stream has been established, the server ",(0,n.mdx)("strong",{parentName:"p"},"may")," terminate the stream by sending an exception to the client. The server ",(0,n.mdx)("strong",{parentName:"p"},"must not")," send any more payloads to the client after it sends an exception. Stream exceptions ",(0,n.mdx)("strong",{parentName:"p"},"must")," be sent using the format specified in ",(0,n.mdx)("a",{parentName:"p",href:"#request-response"},"Request-Response")," with the distinction that the Metadata ",(0,n.mdx)("strong",{parentName:"p"},"must")," contain a Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamPayloadMetadata"))," struct instead of a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct. Additionally, if the exception is an internal server error, ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamRpcError"))," struct ",(0,n.mdx)("strong",{parentName:"p"},"must")," be used instead of ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcError"))," struct."),(0,n.mdx)("h3",{id:"flow-control"},"Flow Control"),(0,n.mdx)("p",null,"Thrift stream is flow-controlled using the ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#reactive-streams-semantics"},"RSocket credit mechanism"),"."),(0,n.mdx)("p",null,"Note that request SHOULD always come with at least one credit, which will be consumed by initial response."),(0,n.mdx)("h3",{id:"cancellation"},"Cancellation"),(0,n.mdx)("p",null,"Thrift stream supports cancellation from the client using ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#cancel-frame-0x09"},"RSocket cancellation mechanism"),"."),(0,n.mdx)("h2",{id:"sink"},"Sink"),(0,n.mdx)("p",null,"With an already established connection, the client must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#request_channel-frame-0x07"},"REQUEST_CHANNEL")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Initial request N"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Must be at least 2 (1 initial response, 1 final response)")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized arguments from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#request"},"Interface Protocol"))))),(0,n.mdx)("h3",{id:"sink-initial-response"},"Sink Initial Response"),(0,n.mdx)("p",null,"The initial response must be sent from the server even if there is no initial response type specified in the IDL. The initial response should be sent using the same format as a regular ",(0,n.mdx)("a",{parentName:"p",href:"#request-response"},"Request-Response response")," with the distinction that the Complete flag must only be set if the payload contains an exception."),(0,n.mdx)("h3",{id:"sink-payloads"},"Sink Payloads"),(0,n.mdx)("p",null,"Once a sink has been established, the client can send sink payloads to the server as long as it has credits remaining. To send a sink payload to the server, the client must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#payload-frame-0x0a"},"PAYLOAD")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamPayloadMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized result from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#response"},"Interface Protocol")," using the serialization protocol specified in ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")))),(0,n.mdx)("h3",{id:"sink-exception"},"Sink Exception"),(0,n.mdx)("p",null,"A client can terminate the sink early by sending an exception to the server. The client ",(0,n.mdx)("strong",{parentName:"p"},"must not")," send any more payloads to the server after it sends an exception. The exception ",(0,n.mdx)("strong",{parentName:"p"},"must")," be sent using the format specified in ",(0,n.mdx)("a",{parentName:"p",href:"#request-response"},"Request-Response")," with the distinction that the Metadata ",(0,n.mdx)("strong",{parentName:"p"},"must")," contain a Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamPayloadMetadata"))," struct instead of a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct."),(0,n.mdx)("h3",{id:"final-response"},"Final Response"),(0,n.mdx)("p",null,"The server MAY send a final response to the client any time after the sink has been established. The final response acts as the termination of the sink and the client should not send any more sink payloads to the server. To send a final response to the client, the server MUST send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#payload-frame-0x0a"},"PAYLOAD")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamPayloadMetadata"))," struct")),(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Data"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Thrift serialized result from ",(0,n.mdx)("a",{parentName:"td",href:"/docs/spec/protocol/interface/#response"},"Interface Protocol")," using the serialization protocol specified in ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"RequestRpcMetadata"))," struct")))),(0,n.mdx)("p",null,"The final response may be an exception in which case, it ",(0,n.mdx)("strong",{parentName:"p"},"must")," be sent using the format specified in ",(0,n.mdx)("a",{parentName:"p",href:"#request-response"},"Request-Response")," with the distinction that the Metadata ",(0,n.mdx)("strong",{parentName:"p"},"must")," contain a Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamPayloadMetadata"))," struct instead of a ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcMetadata"))," struct. Additionally, if the exception is an internal server error, ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"StreamRpcError"))," struct ",(0,n.mdx)("strong",{parentName:"p"},"must")," be used instead of ",(0,n.mdx)("a",{parentName:"p",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},(0,n.mdx)("inlineCode",{parentName:"a"},"ResponseRpcError"))," struct."),(0,n.mdx)("h3",{id:"flow-control-1"},"Flow Control"),(0,n.mdx)("p",null,"Sink payloads are flow-controlled using the ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#reactive-streams-semantics"},"RSocket credit mechanism"),"."),(0,n.mdx)("p",null,"Sink responses are NOT flow-controlled. The request SHOULD always come with at least two credits, which will be consumed by initial response and final response."),(0,n.mdx)("h2",{id:"interactions"},"Interactions"),(0,n.mdx)("h3",{id:"factory-functions"},"Factory Functions"),(0,n.mdx)("p",null,"Factory function requests should be sent the same way as their non-interaction counterpart with the ",(0,n.mdx)("inlineCode",{parentName:"p"},"RequestRpcMetadata.createInteraction")," field filled out (Note: ",(0,n.mdx)("inlineCode",{parentName:"p"},"RequestRpcMetadata.interactionId")," must not be set)."),(0,n.mdx)("p",null,"The ",(0,n.mdx)("inlineCode",{parentName:"p"},"InteractionCreate")," struct must contain a unique interaction ID as well as the name of the interaction (as defined in the IDL)."),(0,n.mdx)("h3",{id:"subsequent-requests"},"Subsequent Requests"),(0,n.mdx)("p",null,"All subsequent requests should be sent the same way as their non-interaction counterpart with two important distinctions:"),(0,n.mdx)("ol",null,(0,n.mdx)("li",{parentName:"ol"},(0,n.mdx)("inlineCode",{parentName:"li"},"RequestRpcMetadata.interactionId")," must be set to the Interaction ID that was created by the Interaction factory function (Note: ",(0,n.mdx)("inlineCode",{parentName:"li"},"RequestRpcMetadata.createInteraction")," must not be set)"),(0,n.mdx)("li",{parentName:"ol"},"The request must be sent on the same connection as the original factory function request")),(0,n.mdx)("h3",{id:"termination"},"Termination"),(0,n.mdx)("p",null,"An interaction can only be terminated by the client. If the client has already sent the factory function request to the server before terminating the interaction, it should send a termination signal to the server. Once an interaction is terminated, the client must not send any more requests with that interaction ID."),(0,n.mdx)("p",null,"To send a termination signal, the client must send a ",(0,n.mdx)("a",{parentName:"p",href:"https://rsocket.io/about/protocol/#metadata_push-frame-0x0c"},"METADATA_PUSH")," frame of the following format:"),(0,n.mdx)("table",null,(0,n.mdx)("thead",{parentName:"table"},(0,n.mdx)("tr",{parentName:"thead"},(0,n.mdx)("th",{parentName:"tr",align:"center"},"Field"),(0,n.mdx)("th",{parentName:"tr",align:"center"},"Notes"))),(0,n.mdx)("tbody",{parentName:"table"},(0,n.mdx)("tr",{parentName:"tbody"},(0,n.mdx)("td",{parentName:"tr",align:"center"},"Metadata"),(0,n.mdx)("td",{parentName:"tr",align:"center"},"Compact Protocol serialized ",(0,n.mdx)("a",{parentName:"td",href:"https://github.com/facebook/fbthrift/blob/main/thrift/lib/thrift/RpcMetadata.thrift"},"ClientPushMetadata")," union")))),(0,n.mdx)("h2",{id:"control-messages"},"Control messages"),(0,n.mdx)("p",null,"All Control messages are sent via METADATA_PUSH RSocket frame."),(0,n.mdx)("h3",{id:"control-messages-from-the-server"},"Control messages from the server"),(0,n.mdx)("p",null,"METADATA_PUSH frame sent by the server MUST contain a compact-serialized ServerPushMetadata struct."),(0,n.mdx)("h3",{id:"control-messages-from-the-client"},"Control messages from the client"),(0,n.mdx)("p",null,"METADATA_PUSH frame sent by the client MUST contain a compact-serialized ClientPushMetadata struct."))}p.isMDXComponent=!0}}]);